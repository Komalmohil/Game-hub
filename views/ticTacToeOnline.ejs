<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tic Tac Toe Online - GameHub</title>
  <link rel="stylesheet" href="/css/ticTacToe.css">
</head>
<body>
<%- include('partials/header', { user: user }) %>



  <div class="users">
  <button id="toggleUsersBtn" class="btn">Show Online Users</button>
  <div id="usersContainer" style="display:none;">
    <ul id="userList"></ul>
  </div>
</div>
<div class="main" style="display:flex; gap:20px;">

  <div>
    <h3 id="status">Select a user to start</h3>
    <div class="board" id="board" style="display:grid; grid-template-columns:repeat(3,120px); grid-gap:10px;">
      <% for(let i=0;i<9;i++){ %>
        <div class="cell" data-index="<%= i %>"></div>
      <% } %>
    </div>
      <button class="btn" id="resetBtn">Reset Game</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
const socket = io();
const username = "<%= user.username %>";
const userListEl = document.getElementById("userList");
const cells = document.querySelectorAll(".cell");

let mySymbol = null;
let roomId = null;
let currentTurn = "X";
let boardState = Array(9).fill("");
let isGameOver = false;

socket.emit("joinLobby", username);


const toggleBtn = document.getElementById("toggleUsersBtn");
const usersContainer = document.getElementById("usersContainer");

toggleBtn.addEventListener("click", () => {
  if (usersContainer.style.display === "none") {
    usersContainer.style.display = "block";
    toggleBtn.textContent = "Hide Online Users";
  } else {
    usersContainer.style.display = "none";
    toggleBtn.textContent = "Show Online Users";
  }
});

socket.on("updateUsers", users => {
  userListEl.innerHTML = "";
  Object.entries(users).forEach(([id, name]) => {
    if(name === username) return;
    const li = document.createElement("li");
    li.textContent = name;
    li.style.cursor = "pointer";
    li.onclick = () => {
      socket.emit("challenge", id);
      usersContainer.style.display = "none";
      toggleBtn.textContent = "Show Online Users";
    };
    userListEl.appendChild(li);
  });
});

socket.on("assignSymbol", symbol => {
  mySymbol = symbol;
});

socket.on("startGame", data => {
  roomId = data.roomId;
  boardState.fill("");
  cells.forEach(cell => cell.textContent = "");
  isGameOver = false;
  enableBoard();

  const opponentId = Object.keys(data.players).find(id => id !== socket.id);
  const opponentName = data.usernames[opponentId];
  document.getElementById("status").innerText = `Playing with ${opponentName}`;
});


cells.forEach(cell => {
  cell.addEventListener("click", () => {
    const idx = parseInt(cell.dataset.index);
    if(isGameOver) return;
    if(boardState[idx] !== "" || mySymbol !== currentTurn) return;

    socket.emit("makeMove", { roomId, idx });
  });
});

socket.on("boardUpdate", ({ idx, symbol }) => {
  boardState[idx] = symbol;
  cells[idx].textContent = symbol;
});

socket.on("updateTurn", turn => {
  currentTurn = turn;
  updateStatus();
});

socket.on("gameOver", ({ winner }) => {
  isGameOver = true;
  disableBoard();

  if(winner === "draw") {
    document.getElementById("status").innerText = "Draw!";
  } else if(winner === mySymbol) {
    document.getElementById("status").innerText = "You win! Opponent loses!";
  } else {
    document.getElementById("status").innerText = "You lose! Opponent wins!";
  }
});

function updateStatus() {
  if(isGameOver) return;
  document.getElementById("status").innerText =
    mySymbol === currentTurn ? "Your turn!" : "Opponent's turn!";
}

function disableBoard() {
  cells.forEach(cell => cell.style.pointerEvents = "none");
}
function enableBoard() {
  cells.forEach(cell => cell.style.pointerEvents = "auto");
}
document.getElementById('resetBtn').addEventListener('click', () => {
  if (!roomId) return; 

  boardState.fill("");
  cells.forEach(cell => cell.textContent = "");
  isGameOver = false;
  currentTurn = "X"; 

  enableBoard();
  updateStatus();

  socket.emit("resetGame", { roomId });
});
socket.on("resetGame", ({ board, turn }) => {
  boardState = board;
  cells.forEach(cell => (cell.textContent = ""));
  currentTurn = turn;
  isGameOver = false;
  enableBoard();
  updateStatus();
});

</script>
</body>
</html>
